name: build-moltbot-images

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write

env:
  UPSTREAM_REPO: moltbot/moltbot
  IMAGE_REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}
  IMAGE_PREFIX_DEFAULT: moltbot

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.guard.outputs.skip }}
      tag: ${{ steps.release.outputs.tag }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get latest release tag
        id: release
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${UPSTREAM_REPO}/releases/latest"
          tag="$(curl -fsSL -H "Authorization: Bearer ${{ github.token }}" "$api" | jq -r '.tag_name')"
          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            tag="$(git ls-remote --tags --refs "https://github.com/${UPSTREAM_REPO}.git" \
              | awk -F/ '{print $NF}' \
              | sort -V \
              | tail -n1)"
          fi
          if [ -z "$tag" ]; then
            echo "Failed to resolve latest tag for ${UPSTREAM_REPO}" >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Check last built tag
        id: guard
        run: |
          set -euo pipefail
          tag="${{ steps.release.outputs.tag }}"
          if [ -f .last_built_tag ]; then
            last="$(tr -d ' \n\r' < .last_built_tag)"
            if [ "$last" = "$tag" ]; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Checkout upstream at tag
        if: steps.guard.outputs.skip != 'true'
        run: |
          git clone --depth 1 --branch "${{ steps.release.outputs.tag }}" \
            "https://github.com/${UPSTREAM_REPO}.git" upstream

      - name: Discover build targets
        id: matrix
        if: steps.guard.outputs.skip != 'true'
        run: |
          python3 scripts/discover_targets.py upstream > matrix.json
          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.skip != 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Checkout upstream at tag
        run: |
          git clone --depth 1 --branch "${{ needs.prepare.outputs.tag }}" \
            "https://github.com/${UPSTREAM_REPO}.git" upstream

      - name: Normalize image namespace
        run: |
          echo "IMAGE_NAMESPACE=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.image }}:${{ needs.prepare.outputs.tag }}
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.image }}:latest

  finalize:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.skip != 'true' && needs.build.result == 'success'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update last built tag
        run: |
          echo "${{ needs.prepare.outputs.tag }}" > .last_built_tag
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .last_built_tag
          git commit -m "chore: update last built tag to ${{ needs.prepare.outputs.tag }}" || exit 0
          git push
